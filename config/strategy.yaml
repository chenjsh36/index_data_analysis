# 策略配置：按策略名分组，RSI 参数与风控
# v2 回测配置见 backtest 段；策略级参数见 strategies.<name>

# ---------------------------------------------------------------------------
# 回测专用配置（全局，仅影响 run_backtest；见 docs/v2/04-technical-design.md）
# ---------------------------------------------------------------------------
backtest:
  # 是否在每根 K 线检查止损/止盈触达并平仓（true=启用，与实盘风控一致）
  use_stop_loss_take_profit: true
  # 是否启用趋势破位止损：收盘价跌破/站上 50 日均线时平仓
  use_ma50_exit: false
  # 回撤熔断：累计回撤超阈值时平仓并暂停开仓
  circuit_breaker:
    enabled: false
    drawdown_threshold: 0.10   # 触发熔断的回撤比例，如 0.10 表示 10%
    position_after: 0.30      # 熔断后允许的最大仓位比例（当前实现为平仓后 cooldown）
    cooldown_bars: 2          # 熔断后禁止新开仓的 K 线数量
  # 绩效指标计算
  metrics:
    risk_free_rate: 0.0       # 夏普比率计算用无风险利率（年化），如 0.02 表示 2%
  commission: 0.0005          # 单边手续费比例，如 0.0005 表示 0.05%

# ---------------------------------------------------------------------------
# 策略定义：strategies.<策略名> 下为各策略参数
# ---------------------------------------------------------------------------
strategies:
  NDX_short_term:
    index_code: "QQQ"         # 关联指数代码，用于数据源与展示
    period_type: "short"      # 周期类型：short 表示短线（3–10 天）
    hold_days: [3, 10]        # 建议持仓天数区间（日），供参考
    # v2：是否启用顶/底背离信号（true=启用，会参与信号组合）
    use_divergence: false
    # 仅多不空 / 牛市禁空（用于回测对比，见 docs/v3/08-backtest-poor-performance-analysis.md）
    long_only: true          # true=禁止开空，只做多
    no_short_in_bull: false   # true=在 bull 环境下禁止开空，其他环境可空
    # RSI 与各市场环境下的超买超卖阈值（与 design.md 一致）
    rsi_params:
      short_period: 9         # RSI 短周期（日）
      long_period: 24         # RSI 长周期（日），用于金叉/死叉
      thresholds:             # 按市场环境（bull/bear/oscillate/transition）的阈值
        bull:                 # 牛市：提高超买、放宽超卖
          overbuy: 80
          strong_overbuy: 85
          oversell: 40
          strong_oversell: 35
        bear:                 # 熊市：降低超买、收紧超卖
          overbuy: 60
          strong_overbuy: 65
          oversell: 20
          strong_oversell: 15
        oscillate:            # 震荡市：BRD 65 减 35 加
          overbuy: 65
          strong_overbuy: 70
          oversell: 35
          strong_oversell: 30
        transition:           # 过渡期：与 oscillate 相同
          overbuy: 70
          strong_overbuy: 75
          oversell: 30
          strong_oversell: 25
    # 风控：仓位与止损止盈比例（策略层输出，回测/实盘共用）
    risk_control:
      max_position: 0.8       # 最大仓位比例（按市场环境可能进一步限制）
      stop_loss_ratio: 0.03   # 止损比例，如 0.03 表示 3%
      take_profit_ratio: 0.07 # 止盈比例，如 0.07 表示 7%
      is_leverage_etf: false  # 是否为杠杆 ETF（true 时止损比例通常更大，如 5%）
    # 信号级止损止盈（TASK-09）：按 reason 差异化比例
    signal_risk:
      default:
        stop_loss_ratio: 0.03
        take_profit_ratio: 0.07
      overbought:
        stop_loss_ratio: 0.02
        take_profit_ratio: 0.05
      strong_overbought:
        stop_loss_ratio: 0.02
        take_profit_ratio: 0.05
      oversell:
        stop_loss_ratio: 0.02
        take_profit_ratio: 0.05
      strong_oversell:
        stop_loss_ratio: 0.02
        take_profit_ratio: 0.05
      golden_cross:
        stop_loss_ratio: 0.03
        take_profit_ratio: 0.07
      death_cross:
        stop_loss_ratio: 0.03
        take_profit_ratio: 0.07
      bullish_divergence:
        stop_loss_ratio: 0.04
        take_profit_ratio: 0.08
      bearish_divergence:
        stop_loss_ratio: 0.04
        take_profit_ratio: 0.08
    # 动态仓位上限（TASK-12 填充）：强超买/强超卖时 cap 调整
    dynamic_cap:
      bull_overbought: 0.5    # 牛市 RSI > strong_overbuy 时 cap
      bear_oversell: 0.5      # 熊市 RSI < strong_oversell 时 cap

  # -------------------------------------------------------------------------
  # v4: EMA 策略（与 nasdaq_v1 逻辑一致）
  # -------------------------------------------------------------------------
  EMA_cross_v1:
    index_code: "QQQ"
    short_ema: 50
    long_ema: 200
    rebalance_freq: "daily"   # daily | monthly
    stop_loss_ratio: 0.05
    risk_control:
      stop_loss_ratio: 0.05
      take_profit_ratio: 0.20

  EMA_trend_v2:
    index_code: "QQQ"
    ema_fast: 80
    ema_slow: 200
    vol_window: 20
    vol_threshold: 0.02
    risk_control:
      stop_loss_ratio: 0.05
      take_profit_ratio: 0.20