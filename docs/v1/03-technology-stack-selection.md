# 技术栈选型文档（Technology Stack Selection）

**文档版本**：1.0  
**产出日期**：2026-02-08  
**依据**：研发流程步骤 3 - 技术栈选择  
**上游输入**：`02-requirements-documentation.md`、`tech_v1.md`、`tech_v2.md`

---

## 1. 选型目标与范围

基于需求规格说明书，本系统以**数据获取 → 指标计算 → 信号生成 → 策略/回测/风控**为核心链路，可选监控与可视化。技术栈需满足：

- 高效处理时序行情数据（OHLCV）与指标计算（RSI、均线、量能比）。
- 支持手写指标实现与开源库双路径验证（如 TA-Lib）。
- 策略与参数配置化（YAML），接口抽象便于多指数/多周期扩展。
- 回测框架成熟、可复现，便于达到胜率/回撤等绩效目标。
- 首版可单机部署，后续可扩展数据持久化与定时任务。

---

## 2. 技术栈选型结论总览

| 层次 | 选型 | 版本建议 | 说明 |
|------|------|----------|------|
| **开发语言** | Python | 3.9+ | 量化/数据分析生态成熟，与 tech_v1/v2 一致 |
| **数据处理与计算** | pandas, numpy | 当前稳定版 | 时序计算、指标实现与验证 |
| **行情数据源** | yfinance | 当前稳定版 | NDX/QQQ/TQQQ 免费获取，接口简单 |
| **技术指标验证** | TA-Lib | 当前稳定版 | RSI/均线等行业标准验证 |
| **回测框架** | Backtrader 或 VectorBT | 二选一 | 事件驱动/向量化回测，与需求匹配 |
| **配置管理** | YAML（PyYAML） | - | 策略参数、数据源配置（与 tech_v2 一致） |
| **数据持久化（可选）** | SQLite / TimescaleDB | 首版 SQLite | 历史数据与回测结果存储，扩展时可用时序库 |
| **缓存/实时（可选）** | Redis | 可选 | 近实时信号与行情缓存（FR-10 深化时） |
| **运行与部署** | 本地 / Docker | 首版本地 | 环境隔离与复现 |
| **测试** | pytest | 当前稳定版 | 单测、指标验证自动化 |
| **可视化（可选）** | 待定（步骤 4 或实现时再定） | - | FR-10 可选；若做 Web 面板再选型并引用设计系统 |

---

## 3. 技术选型评估

### 3.1 开发语言：Python 3.9+

| 维度 | 评估 |
|------|------|
| 成熟度 | 量化与数据分析事实标准，大量金融/回测库基于 Python。 |
| 生态 | pandas/numpy 处理 OHLCV 与指标计算；TA-Lib、Backtrader 等直接支持。 |
| 学习曲线 | 与现有 tech 文档、团队常见技能匹配。 |
| 性能 | 数值计算依赖 numpy/pandas 底层实现，对日线/30 分钟级数据量足够。 |
| 可维护性 | 类型注解（Type Hints）+ 接口抽象，便于扩展与单测。 |

**结论**：保持与 tech_v1/v2 一致，选用 **Python 3.9+**。

---

### 3.2 数据处理与计算：pandas + numpy

| 维度 | 评估 |
|------|------|
| 成熟度 | 行业标准，长期稳定。 |
| 与需求匹配 | 时序对齐、rolling、diff 等直接支持 RSI/MA/量能计算。 |
| 生态 | 与 yfinance、TA-Lib、回测框架无缝衔接。 |

**结论**：**pandas**、**numpy** 作为核心数据处理与指标计算基础，不引入额外计算框架。

---

### 3.3 行情数据源：yfinance

| 维度 | 评估 |
|------|------|
| 成熟度 | 基于 Yahoo Finance API，广泛使用。 |
| 覆盖 | 支持 NDX（^NDX）、QQQ、TQQQ 等标的，日线/分钟级。 |
| 成本 | 免费，满足首版与回测需求。 |
| 风险 | API 变更或限流需关注；通过抽象数据源接口可后续切换 Bloomberg/其他源。 |

**结论**：首版采用 **yfinance**；通过 **BaseDataSource** 抽象（tech_v2）便于扩展其他数据源。

---

### 3.4 技术指标验证：TA-Lib

| 维度 | 评估 |
|------|------|
| 成熟度 | 金融技术分析常用 C 库，Python 绑定稳定。 |
| 与需求匹配 | 提供 RSI、MA 等，用于对手写实现做偏差≤0.1 的验证（NFR-01、FR-07）。 |
| 替代方案 | Pandas TA、talib 等；TA-Lib 与文档约定一致，优先保留。 |

**结论**：采用 **TA-Lib** 作为指标验证基准；手写实现为主路径，TA-Lib 仅用于验证与单测。

---

### 3.5 回测框架：Backtrader / VectorBT 二选一

| 维度 | Backtrader | VectorBT |
|------|------------|----------|
| 模型 | 事件驱动，按 Bar 推进，逻辑清晰 | 向量化，回测速度快 |
| 与需求匹配 | 易实现「按日推进+策略规则+风控」 | 适合规则明确、少状态策略的快速回测 |
| 生态与文档 | 文档多，社区熟 | 较新，API 偏向量化 |
| 扩展性 | 策略类可封装多指数/多周期 | 需在向量化框架下封装 |

**结论**：  
- **首选 Backtrader**：与 tech_v1 一致，事件驱动便于实现趋势/量能/RSI 组合规则与风控。  
- **备选 VectorBT**：若回测数据量或策略数量显著增大，可评估向量化迁移以提升效率。

---

### 3.6 配置管理：YAML（PyYAML）

| 维度 | 评估 |
|------|------|
| 与需求匹配 | FR-08、tech_v2 要求策略与参数配置化，按指数+周期分组。 |
| 可读性 | 适合非开发人员微调阈值与风控参数。 |
| 实现成本 | PyYAML 轻量，无额外服务依赖。 |

**结论**：使用 **YAML** 作为策略与数据源配置格式，**PyYAML** 解析；配置结构对齐 tech_v2 示例（如 `config/datasource.yaml`、`config/strategy.yaml`）。

---

### 3.7 数据持久化（可选）

| 场景 | 选型 | 说明 |
|------|------|------|
| 首版 / 轻量 | SQLite | 单文件、零运维，存历史行情与回测结果足够。 |
| 扩展 / 时序优化 | TimescaleDB 或 InfluxDB | 若需长周期、多标的、分钟级海量数据再引入。 |

**结论**：首版采用 **SQLite**；接口抽象为「存储适配器」，便于后续切换时序库。

---

### 3.8 运行与部署

| 维度 | 选型 | 说明 |
|------|------|------|
| 开发与单机运行 | 本地 Python 环境 + venv/conda | 简单可复现。 |
| 环境隔离与交付 | Docker | 与 tech_v1 一致，便于镜像构建与部署。 |
| 定时任务（可选） | cron / APScheduler | 若实现定时拉数据、算信号、告警时使用。 |

**结论**：首版以**本地运行**为主；**Docker** 作为推荐部署方式，在步骤 4 中细化。

---

### 3.9 测试：pytest

| 维度 | 评估 |
|------|------|
| 与需求匹配 | NFR-06 要求关键指标与策略逻辑单测，覆盖率≥90%。 |
| 实践 | 指标验证（手写 vs TA-Lib）、策略规则单元测试、回测结果断言。 |

**结论**：使用 **pytest** 作为单测与验证框架；关键指标与策略模块纳入 CI（可选）。

---

### 3.10 可视化（可选，FR-10）

需求中可视化为 **Could**，首版以后端与回测为主。若后续实现 Web 监控面板：

- **技术选型**：在步骤 4 或实现阶段再定（如 FastAPI + 简单前端，或 Streamlit/Dash 快速原型）。
- **设计系统**：工作区存在 **ui-ux-pro-max** agent skill（`.cursor/skills/ui-ux-pro-max/SKILL.md`）。若后续开发 Web 端可视化，应在该阶段调用该 skill 生成设计系统（如 `design-system/MASTER.md`），并在技术方案与代码中引用，保证界面规范一致。

**结论**：本步骤不强制生成设计系统；在「实现可选可视化」时再调用 ui-ux-pro-max 并产出设计系统作为附加输出。

---

## 4. 技术栈对比与取舍

| 备选方案 | 取舍 | 原因 |
|----------|------|------|
| 其他语言（如 Node.js/Go） | 不采用 | 量化与指标库生态不如 Python，与现有 tech 文档不符。 |
| 仅手写指标、不引入 TA-Lib | 不采用 | 需求明确要求与权威库验证（FR-07、NFR-01）。 |
| 仅 TA-Lib、不手写 | 不采用 | tech_v2 要求手写+验证，保证可解释性。 |
| 回测用自研循环 | 不采用 | Backtrader 等成熟框架更易满足绩效统计与可复现性。 |
| 配置用 JSON/环境变量 | 不采用 | YAML 更适合作策略/数据源的多层配置，与 tech_v2 一致。 |

---

## 5. 依赖清单（核心）

以下为建议的 **核心** 依赖（版本以当前稳定版为准，实施时在 requirements.txt 中锁定）：

```
# 语言与运行时
Python >= 3.9

# 数据处理与计算
pandas
numpy

# 数据源
yfinance

# 指标验证
TA-Lib  # 需系统级安装或 conda install ta-lib

# 回测
backtrader

# 配置
PyYAML

# 测试
pytest
pytest-cov  # 覆盖率≥90%

# 可选：数据持久化
# sqlite3 为标准库，无需单独安装

# 可选：部署
# Docker 在部署阶段再定 Dockerfile 与镜像
```

---

## 6. 与需求/架构的对应关系

| 需求/架构点 | 技术栈映射 |
|-------------|------------|
| FR-01 数据获取与预处理 | yfinance + BaseDataSource 抽象 + pandas 清洗 |
| FR-02 指标计算 | pandas/numpy 手写 + TA-Lib 验证 |
| FR-06 历史回测 | Backtrader（或 VectorBT） |
| FR-08 配置化 | YAML + PyYAML |
| FR-07 手写与验证 | 手写模块 + TA-Lib 比对 + pytest |
| NFR-06 可测试性 | pytest + pytest-cov |
| tech_v2 多指数/多周期 | 数据源与策略抽象接口 + YAML 配置 |
| 可选监控/告警（FR-10） | 后续可增加 APScheduler + 告警渠道；若做 Web 面板再选型并引用设计系统 |

---

## 7. 风险与注意事项

| 风险 | 缓解 |
|------|------|
| TA-Lib 安装依赖（C 库） | 使用 conda 安装或官方预编译 wheel；或短期用 pandas-ta 等纯 Python 库做验证替代。 |
| yfinance API 变更/限流 | 抽象数据源接口，预留替换为其他数据源；必要时增加重试与退避。 |
| 回测与实盘差异 | 严格按需求加入手续费、滑点与风控逻辑；回测结果仅作参考，实盘需单独合规。 |

---

## 8. 输出物与检查点

| 输出物 | 状态 |
|--------|------|
| 技术栈选型文档 | ✅ 本文档 |
| 技术选型评估（多维度） | ✅ 第 3 节 |
| 技术栈对比与取舍 | ✅ 第 4 节 |
| 核心依赖清单 | ✅ 第 5 节 |
| 设计系统 | ⏸ 可选可视化（FR-10）实现时再调用 ui-ux-pro-max 生成 |

---

**下一步**：确认技术栈选型后，进入「步骤 4：技术方案设计」。若需调整某类技术（如回测框架、数据源或配置格式），可直接指出。
