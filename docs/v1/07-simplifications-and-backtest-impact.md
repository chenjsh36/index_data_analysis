# v1 简化实现与回测表现分析

**文档版本**：1.0  
**产出日期**：2026-02-09  
**目的**：对照 PRD/TDD，梳理 v1 代码中标注的简化逻辑，并评估其是否可能导致回测结果未达目标（胜率 48%、总收益 -29%、最大回撤 33% 等）。

---

## 1. 简化点汇总

### 1.1 信号与策略逻辑

| 位置 | 简化内容 | PRD/TDD 预期 | 对回测的可能影响 |
|------|----------|--------------|------------------|
| `rsi_signals.py` 模块说明 | **背离首版简化（可后续扩展）** | 顶背离/底背离需结合价格高低点 + RSI 高低点 + 量能 | 缺少一类高价值过滤与入场：无法用背离过滤假突破或增强抄底/逃顶质量，可能增加假信号、降低胜率与盈亏比。 |
| `market_env.py` L46 | **连续 2 日收盘价与 MA50 关系（简化：用最近一根）** | 设计文档：连续 2 日站上/跌破 MA50 才定趋势 | 环境在「牛/熊/震荡」间切换更频繁，阈值与趋势过滤不稳定，可能产生更多误判与无效交易。 |

### 1.2 回测引擎

| 位置 | 简化内容 | 常规/设计预期 | 对回测的可能影响 |
|------|----------|----------------|------------------|
| `runner.py` L64 | **平仓：简化按当前仓位与价格算一次 PnL** | 可考虑多笔分批建仓/加仓的均价 | 若未来支持分批建仓，当前等价于按最后一笔入场价统一结算，对单次一开一平影响不大；对当前 v1 单次开平影响较小。 |
| `runner.py` L88-91 | **盈亏比**：代码用 `win_rate / (1 - win_rate)` 作为 profit_factor | 标准盈亏比 = 总盈利 / 总亏损（或 gross profit / gross loss） | **报表指标与标准定义不一致**：当前「profit_factor」实为胜率推导值，不能反映真实盈亏比；不能据此判断策略是否达到「盈亏比≥1.5」。 |
| `runner.py` L90 | **夏普**：用 `(total_return/年数) / (max_dd + ε)` 近似 | 标准夏普 = (收益 - 无风险) / 收益波动率（标准差） | 与通用夏普定义不同，仅作粗略参考；不改变实际盈亏，但不利于与文献或目标对比。 |
| `runner.py` 整体 | **未使用止损/止盈**：平仓仅由信号翻转触发 | TDD/风控层输出 stop_loss、take_profit；PRD 要求趋势破位止损等 | **影响大**：亏损单不会因触及止损提前出场，会一直持有到下次反向/观望信号，容易放大单笔亏损和最大回撤，直接拉低总收益与夏普。 |

### 1.3 风控与数据（补充）

| 位置 | 说明 | 对回测的可能影响 |
|------|------|------------------|
| `risk/control.py` | 极端行情仅用 RSI 极值（无 VIX 数据时） | 若未接入 VIX，极端行情过滤仅靠 RSI，逻辑与 PRD「VIX>30 且 RSI 极值」有差异，影响边界情况。 |
| 回测层 | 未实现「回撤熔断」（如回撤≥10% 降仓/暂停） | 回测中不会因回撤超限减仓或暂停，实际回撤可能被高估或与实盘规则不一致。 |

---

## 2. 结论：简化是否可能导致当前回测结果？

**会。** 下列简化与缺失**很可能显著加剧**当前回测的亏损与回撤，而不仅是「指标口径」问题：

1. **回测未使用止损/止盈**  
   亏损头寸仅随信号平仓，不随价格触及止损/止盈出场，会拉长亏损持仓时间、放大单笔亏损和最大回撤，并直接拖累总收益与夏普。这与 PRD/TDD 中的风控设计不一致。

2. **市场环境用「最近一根」代替「连续 2 日」**  
   趋势/环境判定更敏感，牛熊震荡切换更频繁，RSI 阈值与「趋势 > 量能 > RSI」的过滤稳定性下降，可能增加假信号与无效交易，不利于胜率与盈亏比。

3. **未实现背离**  
   缺少顶/底背离的过滤与入场，无法利用设计中的一类高价值信号，可能使胜率与盈亏比低于「完整实现」时的水平。

4. **盈亏比/夏普等指标为简化公式**  
   不改变真实交易序列与资金曲线，但「profit_factor」与标准定义不符，无法据此判断是否达到「盈亏比≥1.5」；夏普也为近似，仅作参考。

---

## 3. 建议的后续动作（优先级）

| 优先级 | 动作 | 说明 |
|--------|------|------|
| P0 | 回测中接入止损/止盈出场 | 按风控层给出的 stop_loss、take_profit（及可选趋势破位止损），在每根 K 线检查是否触达，触达则平仓并计入 PnL；再统计胜率、回撤、总收益。 |
| P1 | 市场环境改为「连续 2 日」 | 在 `judge_market_env` 中按设计实现「连续 2 日收盘价与 MA50 关系」，与 TDD 一致，减少环境抖动。 |
| P1 | 按标准定义计算绩效指标 | profit_factor = 总盈利 / 总亏损；夏普 = (年化收益 - 无风险) / 年化收益标准差；并可选补充真实盈亏比（平均盈利/平均亏损）。 |
| P2 | 实现背离逻辑（顶/底背离） | 按 design.md/PRD 实现背离识别与量能等条件，作为过滤或独立信号，再回测对比。 |
| P2 | 回测中实现回撤熔断（可选） | 若 PRD 要求，在回测引擎中增加「累计回撤≥阈值则降仓/暂停」逻辑，使回测与实盘规则一致。 |

完成 P0、P1 后，建议用同一区间（如 2018–2025、QQQ）重新跑回测，对比「仅信号平仓」与「信号 + 止损止盈」的胜率、最大回撤、总收益与夏普，再评估是否仍需优化信号与背离逻辑。

---

## 4. 附录：代码引用

- 背离简化：`ndx_rsi/signal/rsi_signals.py` 模块 docstring  
- 连续 2 日简化：`ndx_rsi/indicators/market_env.py` L46 注释  
- 回测平仓与指标：`ndx_rsi/backtest/runner.py` L64、L88–91  
- 风控输出（未在回测中使用）：`ndx_rsi/strategy/ndx_short.py` 中 `calculate_risk` 与 `risk/control.py` 的止损止盈
