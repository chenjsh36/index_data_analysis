# 需求梳理文档（Requirements Gathering）— v2

**文档版本**：v2  
**产出日期**：2026-02-09  
**依据**：研发流程步骤 1 - 需求梳理；上游输入 `docs/v1/07-simplifications-and-backtest-impact.md`  
**参考规范**：IEEE 830-1998 SRS、BABOK、User Story (INVEST)、5W1H、MoSCoW

---

## 一、v2 范围与 5W1H

v2 针对 **v1 简化实现导致的回测表现未达标** 做补齐与修正，不改变 v1 已实现的数据/指标/信号主流程，仅在指定模块做增强与回测引擎对齐。

| 维度 | 说明 |
|------|------|
| **Who（谁）** | 与 v1 一致：NDX/QQQ/TQQQ 短线交易者、策略/量化开发、运维；v2 额外关注「回测结果可信度」与「风控在回测中的一致性」。 |
| **What（做什么）** | 补齐/修正：(1) 回测引擎接入止损/止盈与回撤熔断；(2) 市场环境判定改为「连续 2 日」；(3) 绩效指标按标准定义计算；(4) 可选实现顶/底背离信号；使回测与 PRD/TDD 风控与指标定义一致，便于达成胜率≥62%、盈亏比≥1.5、最大回撤≤15%/20%。 |
| **When（何时）** | 在每根 K 线推进时检查止损/止盈触达与回撤熔断；市场环境与绩效计算在现有回测与信号流程中生效。 |
| **Where（在哪）** | 回测层（`ndx_rsi/backtest/runner.py`）、计算层市场环境（`ndx_rsi/indicators/market_env.py`）、信号层 RSI（`ndx_rsi/signal/rsi_signals.py` 及组合逻辑）；配置与风控层沿用 v1。 |
| **Why（为什么）** | v1 回测未使用止损/止盈、环境用「最近一根」简化、绩效公式非标准，导致回测结果（胜率 48%、总收益 -29%、回撤 33%）与设计目标偏离；v2 通过补齐逻辑与指标口径，使回测可正确评估策略并对照 PRD 验收。 |
| **How（怎么做）** | 在回测循环中每 Bar 检查风控层给出的 stop_loss/take_profit 及可选趋势破位；judge_market_env 改为连续 2 日收盘与 MA50 关系；报表中 profit_factor = 总盈利/总亏损、夏普 = (年化收益 - 无风险)/收益标准差；可选实现背离识别并接入组合信号。 |

---

## 二、利益相关者与用户角色（与 v1 一致，v2 侧重）

| 角色 | 描述 | v2 关注点 |
|------|------|-----------|
| **交易者** | NDX/QQQ/TQQQ 短线波段交易 | 回测中的止损/止盈与实盘一致、绩效指标可对标行业标准 |
| **策略/量化开发** | 实现与维护策略与回测 | 回测引擎与风控/指标定义一致、市场环境判定符合 TDD、可对比「仅信号平仓」与「信号+止损止盈」结果 |
| **运维/监控** | 数据与任务稳定、告警 | 回撤熔断在回测中可验证，与实盘规则一致 |

---

## 三、需求清单（Requirements List）— v2 增量

### 3.1 功能需求（v2 增量，MoSCoW）

| ID | 需求描述 | 优先级 | 来源（07 章节） |
|----|----------|--------|-----------------|
| FR-v2-01 | **回测引擎在每根 K 线检查止损/止盈**：使用风控层给出的 stop_loss、take_profit（及策略配置的止损止盈比例），若当日 high/low 触达则在该 Bar 内平仓并计入 PnL，再继续按信号推进 | Must | 07 §1.2 P0 |
| FR-v2-02 | **回测引擎支持可选「趋势破位止损」**：若约定为收盘价有效跌破/站上 50 日均线则平仓，在回测中可配置开启并与止损/止盈一并生效 | Should | 07 §1.2、TDD 风控 |
| FR-v2-03 | **市场环境判定改为「连续 2 日」**：`judge_market_env` 中牛/熊判定需满足「连续 2 日收盘价与 MA50 关系」（站上/跌破），与 TDD/设计文档一致，不再使用「最近一根」简化 | Must | 07 §1.1 P1 |
| FR-v2-04 | **回测绩效指标按标准定义计算**：profit_factor = 总盈利 / 总亏损（总亏损为 0 时约定处理，如置为 99 或单独标注）；夏普比率 = (年化收益 - 无风险利率) / 年化收益标准差；可选补充真实盈亏比（如平均盈利/平均亏损） | Must | 07 §1.2 P1 |
| FR-v2-05 | **回测引擎实现回撤熔断（可选可配置）**：累计回撤≥配置阈值（如 10%）时，强制降仓至约定比例（如 30%）并暂停开仓若干交易日（如 2 日），与 PRD FR-11 一致，便于回测与实盘规则对齐 | Should | 07 §1.3、§3 P2 |
| FR-v2-06 | **顶/底背离识别与接入信号组合（可选）**：按 design.md/PRD 实现顶背离（价格创新高、RSI 未创新高）、底背离（价格创新低、RSI 未创新低），并结合量能等条件，作为过滤或独立信号接入 `generate_signal_dict`，可配置开关 | Could | 07 §1.1 P2 |
| FR-v2-07 | **极端行情与 VIX（可选增强）**：若数据源支持，回测与信号中接入 VIX，严格实现「VIX>30 且 RSI 极值则禁止开仓」；无 VIX 时保持当前仅 RSI 极值逻辑并文档说明 | Could | 07 §1.3 |

### 3.2 非功能需求（v2 增量）

| ID | 需求描述 | 类型 | 验收参考 |
|----|----------|------|----------|
| NFR-v2-01 | 回测结果可重复：同一策略/标的/区间/配置（含止损止盈、回撤熔断开关）多次运行，核心指标（胜率、总收益、最大回撤、profit_factor、夏普）一致 | 正确性/可重复性 | 07、FR-v2-04 |
| NFR-v2-02 | 绩效报表中的 profit_factor、夏普与行业常用定义一致，便于与 PRD 目标（盈亏比≥1.5）及外部基准对比 | 正确性 | 07 §1.2、FR-v2-04 |
| NFR-v2-03 | 市场环境判定逻辑与 TDD/设计文档一致，且有单测或回测片段可验证「连续 2 日」行为 | 可测试性 | FR-v2-03 |

---

## 四、用户故事（v2 增量，INVEST）

| ID | 用户故事 | 验收标准 |
|----|----------|----------|
| US-v2-01 | 作为策略开发，我希望回测在每根 K 线检查止损/止盈触达并平仓，以便回测结果与实盘风控一致并更真实反映最大回撤与收益 | 回测引擎使用风控层 stop_loss/take_profit，触达即平仓；同一区间下「信号+止损止盈」与「仅信号」结果可对比 |
| US-v2-02 | 作为策略开发，我希望市场环境按「连续 2 日」与 MA50 关系判定，以便减少牛熊震荡误判与无效交易 | judge_market_env 满足连续 2 日站上/跌破 MA50 才标 bull/bear；有测试或历史片段验证 |
| US-v2-03 | 作为策略开发，我希望回测报表中的盈亏比与夏普按标准定义计算，以便判断是否达到「盈亏比≥1.5」等 PRD 目标 | profit_factor = 总盈利/总亏损；夏普公式为 (年化收益 - 无风险)/收益标准差；文档或注释标明无风险利率取值 |
| US-v2-04 | 作为交易者，我希望回测中若启用回撤熔断，则超阈值时降仓并暂停开仓，以便与实盘风控一致 | 回测支持回撤熔断开关与参数，行为与 PRD FR-11 描述一致并可验证 |
| US-v2-05 | 作为策略开发，我希望能选择是否启用顶/底背离信号并在回测中对比效果，以便评估背离对胜率与盈亏比的贡献 | 背离逻辑可配置开关，回测可产出有/无背离的对比指标（若实现 FR-v2-06） |

---

## 五、用例摘要（v2 增量）

| 用例 | 参与者 | 主要流程 | 后置条件 |
|------|--------|----------|----------|
| 回测 Bar 内止损/止盈检查 | 回测引擎 | 每 Bar 取策略与风控的 stop_loss/take_profit → 用当日 high/low 判断是否触达 → 触达则平仓、计入 PnL、更新仓位与权益 | 亏损/盈利头寸可提前出场，回撤与收益更贴近实盘 |
| 市场环境连续 2 日判定 | 系统 | 取最近 2 日收盘价与 MA50 → 仅当两日均站上/跌破且斜率满足时标 bull/bear → 否则 oscillate/transition | 环境标签与 TDD 一致，减少抖动 |
| 标准绩效计算 | 回测引擎 | 按成交与 PnL 汇总总盈利、总亏损 → profit_factor = 总盈利/总亏损；按日/Bar 收益序列算年化与标准差 → 夏普 = (年化 - 无风险)/标准差 | 报表指标与 PRD/行业口径一致 |
| 回撤熔断执行 | 回测引擎 | 每 Bar 更新权益与峰值 → 若 (峰值-权益)/峰值 ≥ 阈值则降仓至约定比例并置「暂停开仓」计数 → 满 N 日后恢复 | 回测与 PRD 回撤熔断规则一致 |
| 背离信号识别（可选） | 信号层 | 识别价格与 RSI 高低点 → 顶背离/底背离满足条件且量能符合时输出信号 → 接入组合逻辑 | 可配置启用，回测可对比有/无背离 |

---

## 六、约束与风险（v2）

### 6.1 约束条件

- **兼容 v1**：v2 变更限于回测引擎、market_env、绩效计算及可选信号扩展，不破坏 v1 已有 CLI、数据层、指标与策略接口。
- **配置与可选**：止损/止盈、趋势破位、回撤熔断、背离等建议通过配置或开关控制，便于 A/B 对比与渐进上线。
- **无风险利率**：夏普计算需约定无风险利率（如 0 或某国债收益率），在配置或文档中明确。

### 6.2 风险识别

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 止损/止盈过于敏感导致频繁出场 | 回测交易次数大增、收益被手续费与滑点侵蚀 | 回测中保留手续费/滑点配置；可选做「仅信号平仓」与「信号+止损止盈」对比 |
| 「连续 2 日」使环境切换滞后 | 趋势反转初期仍用旧环境阈值，信号略滞后 | 接受与 TDD 一致的行为；必要时在 TDD 中补充「过渡期」规则 |
| 背离实现复杂度高、引入新 bug | 信号逻辑复杂、回测不稳定 | 将背离设为 Could、可配置关闭；先完成 P0/P1 再迭代背离 |

---

## 七、需求确认检查点（v2）

1. ✅ 是否仅围绕 07 的优化点展开，未扩大为 v1 全量需求？
2. ✅ 是否已明确 P0（止损/止盈）、P1（连续 2 日、标准指标）、P2（回撤熔断、背离）的优先级与可选性？
3. ✅ 功能需求是否覆盖回测引擎、市场环境、绩效指标、回撤熔断及可选背离？
4. ✅ 非功能需求是否覆盖可重复性、指标口径与可测试性？
5. ✅ 用户故事与用例是否可直接对应到 07 中的「建议的后续动作」？

---

## 八、文档与版本

| 文档 | 路径 | 说明 |
|------|------|------|
| v1 需求梳理 | `docs/v1/01-requirements_gathering.md` | v1 完整需求，v2 在其基础上增量 |
| v1 简化与回测影响 | `docs/v1/07-simplifications-and-backtest-impact.md` | v2 需求来源与优先级依据 |
| v1 需求规格/技术设计 | `docs/v1/02-requirements-documentation.md`, `04-technical-design.md` | 术语与验收口径一致 |

---

**下一步**：确认 v2 需求范围与优先级后，进入「步骤 2：需求文档（v2）」或直接进入 v2 技术方案/任务拆分。
