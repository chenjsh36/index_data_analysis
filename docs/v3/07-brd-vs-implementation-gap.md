# BRD 与当前代码实现差异对照

**对照依据**：`docs/context/brd.md`（RSI 实操手册 + NDX 专属 + 成交量与 50 日均线配合）  
**代码范围**：`ndx_rsi/` 策略、指标、信号、风控、回测  
**日期**：2026-02-09

---

## 一、已实现且与 BRD 基本一致的部分

| BRD 要求 | 实现位置 | 说明 |
|----------|----------|------|
| RSI 公式（SMA 涨幅/跌幅，RS = AvgU/AvgD，RSI = 100 - 100/(1+RS)） | `indicators/rsi.py` | 手写实现，与 BRD 一致 |
| 9/24 日 RSI 周期（短线波段） | `config/strategy.yaml`、`ndx_short.py` | short_period=9, long_period=24 |
| 50 日均线定趋势（上行/下行/走平±3%） | `indicators/market_env.py`、`signal/trend_volume.py` | 斜率 + 连续 2 日收盘与 MA50 关系 |
| 量能：放量≥1.2、缩量≤0.8、巨量≥1.5、地量≤0.5 | `indicators/volume_ratio.py`、`signal/trend_volume.py` | 以 20 日均量为基准 |
| 牛/熊/震荡超买超卖阈值分级 | `strategy.yaml`、`market_env._THRESHOLDS` | 牛 80/85、熊 60/65、震荡 65/70 等 |
| 趋势 + 量能 + RSI 组合（趋势>量能>RSI） | `signal/combine.py` | 上升忽略单纯超买（除缩量滞涨）、下降忽略单纯超卖等 |
| 金叉/死叉 + 位置过滤（金叉 mid>70/死叉 mid<30 忽略）+ MA5 确认 | `signal/rsi_signals.py`、`combine.py` | close>ma5 金叉、close<ma5 死叉 |
| 顶/底背离（价格新高 RSI 未新高 / 价格新低 RSI 未新低） | `signal/rsi_signals.check_divergence` | 可选 `use_divergence`，默认关闭 |
| 上升趋势底背离+放量→买；下降趋势顶背离+缩量→卖；震荡背离+量能 | `signal/combine.py` | 按趋势分支处理 |
| 仓位上限（牛 80%、熊 30%、震荡 50%） | `risk/control.apply_position_cap` | 与 BRD 一致 |
| 牛市强超买/熊市强超卖时动态降仓（cap 0.5） | `strategy.yaml` dynamic_cap、`apply_position_cap` | bull_overbought / bear_oversell |
| 极端行情禁止开仓（RSI<10 或 RSI>90） | `risk/control.check_extreme_market` | 无 VIX 时仅用 RSI 极值 |
| 信号级差异化止损止盈（超买超卖 2%/5%，背离等 3–4%/7–8%） | `strategy.yaml` signal_risk、`risk/control.get_stop_loss_take_profit` | 按 reason 取比例 |
| 平仓：超买入场后 RSI<65 平、超卖入场后 RSI>35 平 | `signal/combine.py` current_position_info、backtest runner | TASK-11 |
| 回测：止损止盈、趋势破位 MA50 平仓、回撤熔断、夏普/盈亏比 | `backtest/runner.py`、`strategy.yaml` backtest 段 | 可选开关 |

---

## 二、BRD 有描述但当前未实现或明显简化的部分

### 1. 数据与频率

| BRD/design 描述 | 当前实现 | 差异 |
|-----------------|----------|------|
| 日线 + **30 分钟 K 线**辅助择时 | 仅日线（backtest 与策略均为日线） | 未实现 30 分钟线择时 |
| **VIX 恐慌指数**（>30 超卖更可靠、<15 超买更可靠；极端行情 VIX>30 且 RSI 极值） | 风控仅支持传入 vix 参数，**无数据源拉取 VIX**，回测/策略未接 VIX | 未接入 VIX 数据，极端行情仅靠 RSI |
| **前五大权重股**（苹果、微软等）同步背离验证 | 无权重股数据与逻辑 | 背离仅看指数价格+RSI，无权重股联动 |

### 2. 背离信号

| BRD 描述 | 当前实现 | 差异 |
|----------|----------|------|
| 顶背离：**首次确认减仓 50%，二次确认（价格破前高支撑）清仓** | 顶背离一次给出 sell（如 -0.3 或 -1.0），**无“首次/二次”分级** | 无二次确认与阶梯仓位 |
| 底背离：**首次确认加仓 30%，二次确认（价格破前低压力）补仓** | 底背离一次给出 buy（如 0.3/0.5），**无二次确认** | 同上 |
| 背离验证：**连续 3 日缩量/放量**、**权重股同步** | 仅用当日 volume_ratio，无多日连续量能、无权重股 | 验证条件简化 |
| 日 K/周 K 级背离更有效（周线准确率 85%） | 仅日线，无周线周期 | 无周线背离 |

### 3. 趋势与均线

| BRD 描述 | 当前实现 | 差异 |
|----------|----------|------|
| **趋势破位**：RSI 有效跌破 50（**连续 2 个周期**站在 50 以下）+ 价格破 **20 日均线** → 清仓 | 有 use_ma50_exit（收盘价与 MA50），**无“连续 2 周期 RSI<50 + 破 MA20”** 的专门逻辑 | 趋势破位仅 MA50，未用 RSI 连续 2 周期 + MA20 |
| **趋势反转**：RSI 有效站上 50（**连续 2 个周期**站在 50 以上）+ 价格站上 **20 日均线** → 加仓 | 无“连续 2 周期 RSI>50 + 站上 MA20”的加仓规则 | 未实现 |
| 价格**远离 5/10 日均线**（如偏离>3%）作为信号增强 | 未使用价格与 MA5/MA10 的偏离度 | 未实现 |

### 4. 辅助指标与形态

| BRD 描述 | 当前实现 | 差异 |
|----------|----------|------|
| **布林带**：震荡市 RSI 超买+价格触上轨=卖，RSI 超卖+价格触下轨=买 | 无布林带指标与相关信号 | 未实现 |
| K 线形态：顶背离配合乌云盖顶/黄昏星，底背离配合曙光初现/早晨星 | 无 K 线形态识别 | 未实现（design/需求文档已标 Future） |

### 5. 金叉/死叉细节

| BRD 描述 | 当前实现 | 差异 |
|----------|----------|------|
| 金叉后 **RSI 双双站上 50** 且 **价格站上 5 日均线** 的后续确认 | 仅要求金叉时 close>ma5，**无“金叉后 RSI 站上 50”的后续确认** | 仅当根 K 线条件，无后续 K 确认 |
| 死叉后 **RSI 双双跌破 50** 且 **价格跌破 5 日均线** | 仅要求死叉时 close<ma5，无后续确认 | 同上 |
| 无效叉：金叉在 70 以上、死叉在 30 以下；**短期快速穿越无量配合视为诱多/诱空** | 金叉 mid>70/死叉 mid<30 已过滤；**无“快速穿越+无量”的专门过滤** | 部分实现 |

### 6. 仓位与执行细节

| BRD 描述 | 当前实现 | 差异 |
|----------|----------|------|
| 加仓间隔：牛市≥2 日、熊市≥3 日、震荡≥1 日 | 回测按 Bar 逐日，**无“距上次加仓 N 日”限制** | 未实现加仓冷却 |
| 单日最大交易次数 ≤2 | 未限制单日交易次数 | 未实现 |

### 7. 回测与配置

| BRD/design 描述 | 当前实现 | 差异 |
|-----------------|----------|------|
| 背离功能默认**关闭**（use_divergence: false） | 配置为 false，与“先不启用背离”一致 | 一致，但 BRD 中背离是核心反转手段 |
| 止损/止盈/MA50 破位/熔断默认**关闭**（use_stop_loss_take_profit、use_ma50_exit、circuit_breaker.enabled 为 false） | 默认关闭，需手动开启 | 与“可选增强”一致，但与 BRD 实操“带止损止盈”的表述相比偏保守 |

---

## 三、差异汇总表（按优先级）

| 类别 | 差异项 | 建议 |
|------|--------|------|
| **数据** | 无 VIX 数据源，极端行情仅 RSI | 可选：接入 VIX 数据源并传入风控 |
| **数据** | 无 30 分钟线择时 | 若做择时细化再考虑 |
| **数据** | 无权重股、无权重股背离验证 | 标为 Future，与 v3 需求文档一致 |
| **背离** | 无首次/二次确认与阶梯仓位 | 可增强：二次确认（价格破前高/前低）再调仓位 |
| **背离** | 无连续 3 日量能、无周线背离 | 可做增强或 v4 |
| **趋势** | 无“连续 2 周期 RSI 与 50 + MA20”的破位/反转规则 | 可加：清仓/加仓条件与 BRD 对齐 |
| **趋势** | 无价格与 MA5/MA10 偏离度（如 3%） | 可选增强 |
| **指标** | 无布林带、无 K 线形态 | 已标 Future，按需迭代 |
| **金叉死叉** | 无“金叉/死叉后 RSI 站上/跌破 50 + 价格与 MA5”的后续确认 | 可选：多一根 K 线确认 |
| **风控** | 无加仓间隔、无单日交易次数上限 | 可按风控需求补充 |

---

## 四、结论

- **已对齐 BRD 的核心**：RSI 公式与周期、50 日均线趋势、20 日量能比、牛/熊/震荡阈值、趋势+量能+RSI 组合、金叉死叉位置与 MA5、仓位与动态 cap、信号级止损止盈、平仓条件、回测框架与可选开关。
- **主要缺口**：  
  1）**数据**：VIX、30 分钟线、权重股均未接入；  
  2）**背离**：无首次/二次确认与阶梯仓位，无连续量能/权重股/周线；  
  3）**趋势**：无“连续 2 周期 RSI 与 50 + MA20”的破位/反转规则；  
  4）**辅助**：布林带、K 线形态未实现（已标 Future）；  
  5）**执行细节**：加仓间隔、单日交易次数未做限制。

若需进一步对齐 BRD，优先建议：**接入 VIX（可选）**、**背离二次确认与阶梯仓位**、**趋势破位/反转的 RSI 连续 2 周期 + MA20 规则**；其余按产品优先级在 v4 或后续迭代中补齐。
