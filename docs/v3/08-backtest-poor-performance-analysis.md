# 回测绩效差原因分析（NDX_short_term / QQQ 2018–2025）

**结论**：胜率约 42%、累计收益约 -21%、夏普负值，主要来自**未启用止损导致亏损单放大**、**在长牛中做空易被轧空**、以及**盈亏比不足**。以下分点说明并给出可操作建议。

---

## 一、当前回测结果摘要

| 指标 | 数值 |
|------|------|
| win_rate | 0.4257 |
| total_trades | 148 |
| total_return | -0.2081 |
| max_drawdown | 0.2284 |
| sharpe_ratio | -0.4406 |
| profit_factor | 0.7665 |

与「不做任何操作」的买入持有 QQQ 相比：策略明显更差，说明频繁多空切换在样本期内整体是负贡献。

---

## 二、主要原因分析

### 1. 未启用 Bar 内止损/止盈（影响最大）

**配置**：`config/strategy.yaml` 中 `backtest.use_stop_loss_take_profit: false`。

**后果**：

- 亏损单不会在 Bar 内被止损/止盈打断，只会一直持有到出现**反向信号**或**平仓信号**。
- 在趋势行情中，一次错误方向（尤其是做空）可能扛很久，单笔亏损被放大。
- 盈利单同样没有止盈保护，可能回吐；但结合胜率 <50% 和 profit_factor <1，整体是亏损单的负面影响更大。

因此，**关闭止损是回测结果远差于买入持有的重要结构性原因**：亏损不被限制，而盈利又容易被回撤吃掉。

**建议**：将 `use_stop_loss_take_profit` 改为 `true` 后重跑回测，观察胜率、总收益、最大回撤和夏普的变化。策略层已配置 `signal_risk` / `risk_control` 的止损止盈比例，只需在回测层打开即可生效。

---

### 2. 在长牛中做空导致结构性劣势

**样本期**：2018-01-01 至 2025-12-31，QQQ 除 2022 年外整体为长牛。

**策略行为**：

- 策略会做多也会做空（例如死叉、超买+放量等给出 `position < 0`）。
- 在牛市中，死叉、超买往往对应**短期回调**，随后价格继续创新高；此时做空容易被轧空，且没有 Bar 内止损时，单笔亏损会很大。
- 做多部分虽然能吃到趋势，但盈利单可能因未止盈而回吐；做空部分则容易出现少数几笔大亏，拉低整体收益。

因此，**在偏牛样本里，做空次数多、且无止损，会系统性拉低收益和夏普**。

**建议**：

- 在 `strategy.yaml` 或策略逻辑中增加「仅多不空」的选项（例如牛市/过渡期禁止开空），或在回测中先关闭空头再对比。
- 或保持多空但**务必开启止损**，限制单笔空头亏损。

---

### 3. 胜率与盈亏比双弱

- **胜率 42.57%**：不足一半的交易是盈利的。
- **profit_factor 0.7665 < 1**：总盈利/总亏损 < 1，即平均每笔亏损金额大于平均每笔盈利。

在**没有止损**的前提下：

- 亏损单会持有更久，亏损额容易放大。
- 盈利单没有止盈保护，部分会回吐。
- 结果就是「亏的笔数多、且单笔亏得也多」，与观察到的负收益、负夏普一致。

**建议**：先开启止损/止盈，再考虑优化入场条件（例如提高开仓门槛、减少震荡市换手），目标是把胜率或盈亏比至少提升一方。

---

### 4. 信号与换手带来的摩擦

- 约 7 年 148 笔交易，约每周 0.4 次；每次多空切换都以当日收盘价成交并扣除双边手续费（`commission`）。
- 在震荡或假突破阶段，容易「多→空→多」频繁切换，造成连续小亏+手续费，进一步压低净收益。

**建议**：可适当提高信号门槛（如量能、RSI 强度、趋势确认条数），或对「同一方向连续加仓/减仓」做合并，减少无谓换手。

---

### 5. 趋势与市场环境口径不一致（次要）

- **信号组合**（`combine.py`）用的是 `trend_volume.get_trend`：基于**最近 5 日** MA50 斜率（>0.0005 为升、<-0.0005 为降）。
- **RSI 阈值**（`market_env.judge_market_env`）用的是**最近 20 日** MA50 斜率（>0.001 为牛、<-0.001 为熊）决定 bull/bear/oscillate/transition。

两处周期和斜率阈值不同，可能出现「短期看涨、长期看跌」或相反的情况，导致：

- 用短期趋势做买卖方向，用长期环境做超买超卖阈值，有时会不一致。
- 可能增加假信号或错过更清晰的环境过滤。

**建议**：统一趋势与市场环境的 lookback 和斜率标准（例如都改为 20 日且同一组阈值），或在设计文档中明确「短期趋势 + 长期环境」的语义并据此再微调阈值。

---

### 6. 回测实现上的潜在偏差（可选核查）

- **仓位与权益**：当前 runner 在平仓时用 `ret = (price - entry_price)/entry_price * side` 更新权益，并执行 `equity *= 1 + ret`，即**按满仓（100%）**计算该笔对权益的影响。若实际仓位为 0.3/0.4，更合理的做法是 `equity *= 1 + abs(position) * ret`（并考虑 commission）。否则单笔收益/亏损会被放大，总收益和回撤的**绝对值**会偏大（方向不变），可后续按「按仓位加权」修正以便更贴近实盘。
- **入场价**：当前以**当日收盘价**作为成交价。实盘多为下一根 K 线开盘或收盘成交，存在一定前瞻偏差；可在后续版本改为「信号下一 Bar 开盘」再对比。

---

## 三、建议的优先动作

1. **立即**：在 `strategy.yaml` 中设置 `use_stop_loss_take_profit: true`，重新跑回测，看胜率、总收益、最大回撤、夏普是否明显改善。
2. **短期**：在回测或策略中增加「仅多不空」或「牛市禁空」选项，对比同一区间下与当前多空版本的差异。（已实现：在 `config/strategy.yaml` 的 `strategies.NDX_short_term` 下设置 `long_only: true` 或 `no_short_in_bull: true`，同一命令跑回测即可对比；见下方「五、仅多不空/牛市禁空 使用说明」。）
3. **中期**：统一趋势与市场环境的周期/斜率定义，并考虑提高开仓门槛、降低换手，再跑回测对比。
4. **可选**：修正回测中「按仓位比例影响权益」与「下一 Bar 成交」的实现，使回测更贴近实盘。

---

## 四、小结

| 原因 | 影响程度 | 可改性 |
|------|----------|--------|
| 未启用 Bar 内止损/止盈 | 高 | 配置改为 true 即可 |
| 长牛中做空且无止损 | 高 | 可做「仅多」或禁空试验 |
| 胜率与盈亏比双弱 | 高 | 需配合止损+信号/风控优化 |
| 换手与手续费 | 中 | 减少无效信号与换手 |
| 趋势/环境口径不一致 | 中低 | 统一参数与语义 |
| 回测仓位/成交价假设 | 中低 | 代码层面修正 |

整体上，**先打开止损/止盈、再考虑限制或减少做空**，是解释当前回测远差于买入持有、并优先改进的两步。

---

## 五、仅多不空 / 牛市禁空 使用说明（已实现）

在 `config/strategy.yaml` 的 `strategies.NDX_short_term` 下新增两项：

| 配置项 | 含义 | 默认值 |
|--------|------|--------|
| `long_only` | 仅多不空：禁止开空，只做多 | `false` |
| `no_short_in_bull` | 牛市禁空：在 bull 环境下禁止开空，其他环境可空 | `false` |

**对比同一区间**：保持其他参数一致，分别运行：

1. **多空版本（当前默认）**：`long_only: false`，`no_short_in_bull: false`  
   ```bash
   python -m ndx_rsi.cli_main run_backtest --strategy NDX_short_term --symbol QQQ --start 2018-01-01 --end 2025-12-31
   ```

2. **仅多不空**：将 `long_only` 改为 `true` 后执行上述同一命令。

3. **牛市禁空**：将 `long_only` 改回 `false`，将 `no_short_in_bull` 改为 `true` 后执行同一命令。

比较三组结果的 win_rate、total_return、max_drawdown、sharpe_ratio、profit_factor 即可评估「禁空」对绩效的影响。

**示例对比（QQQ 2018-01-01～2025-12-31，同参数）**：

| 指标 | 多空（默认） | 仅多不空 (long_only: true) |
|------|----------------|-----------------------------|
| win_rate | 0.4257 | **0.5094** |
| total_trades | 148 | 53 |
| total_return | -0.2081 | **-0.0523** |
| max_drawdown | 0.2284 | **0.136** |
| sharpe_ratio | -0.4406 | **-0.163** |
| profit_factor | 0.7665 | **0.8595** |

仅多不空在相同区间下收益与回撤明显优于多空版本，说明禁空对当前策略有正向作用；可再试 `no_short_in_bull: true` 做牛市禁空对比。

---

## 六、仅多不空 + 止损开启后仍不达标的原因分析

在已开启「仅多不空」和「Bar 内止损/止盈」后，典型结果约为：**win_rate ≈ 51%、total_return ≈ -1%～-2%、profit_factor ≈ 0.97**。与买入持有相比仍偏弱，可能原因如下。

### 6.1 盈亏比仍略不利（profit_factor < 1）

- **现象**：profit_factor 0.97 < 1，即总盈利仍略小于总亏损，单笔亏损的「总金额」略大于单笔盈利。
- **可能原因**：
  - **止损先于止盈被触发**：多数开仓来自「超卖 + 缩量」或「回踩 50 + 缩量」，入场多在回调中段；下一根 K 线波动 2% 很常见，**2% 止损**容易先被触及，随后价格反弹、错失后续涨幅。
  - **信号驱动退出有时在小亏/小盈**：例如「超买 + 缩量」触发 sell_light 后清仓（仅多不空变为 position=0），若当时略低于成本则按市价平仓为小亏，拉低整体盈利/亏损比。
- **建议**：
  - 适当**放宽多头止损**（如 2%→2.5% 或 3%），或改为基于 ATR 的止损，减少「刚入场就被震出」；
  - 在**保持止损不变**的前提下，**提高止盈比例**（如 5%→7% 或 8%），让盈利单多跑一点，改善盈亏比。

### 6.2 入场时机与止损宽度不匹配

- **逻辑**：策略在**上升趋势**中多在「超卖 + 缩量」或「45–55 RSI 回踩 + 缩量」时买入，即**回调中抄底**。抄底后 1～2 日内再跌 2% 很常见，当前 signal_risk 对 oversell/strong_oversell 为 **2% SL / 5% TP**，容易**先触止损、再反弹**，形成「小亏割肉 → 价格上去」。
- **建议**：
  - 对「超卖/强超卖」类入场单独放宽止损（如 3%），或
  - 入场条件加一层过滤：例如要求「收盘已站上前一日低点」或「RSI 已从极值回升 1～2 根」再开仓，减少在「下跌中继」入场。

### 6.3 在仓时间占比低，错过趋势收益

- **逻辑**：仅多不空下，**只有出现明确做多信号才开仓**（超卖+缩量、金叉、回踩 50 等）。在**强牛阶段**，RSI 长期在 50～80 震荡，**很少进入超卖（≤40）**，导致长时间空仓，错过主升段。
- **结果**：53 笔交易分布在约 7 年，平均每笔持仓若为 1～2 周，则**在仓时间占比可能不足 20%**，大部分时间不参与上涨，收益很难追上买入持有。
- **建议**：
  - 在回测中增加统计「在仓 Bar 数 / 总 Bar 数」或「平均持仓天数」，确认在仓占比；
  - 若确认在仓占比很低，可考虑：在**明确上升趋势**中放宽开仓条件（例如 RSI 回踩 50 且未超卖也允许小仓试多），或增加「趋势跟踪」逻辑：趋势未破坏前以持有为主、少因单日超买就清仓。

### 6.4 上升趋势中「超买 + 缩量」清仓过早

- **逻辑**：当前在上升趋势下，**超买 + 缩量**会触发 sell_light（-0.2～-0.3），仅多不空会转为**清仓（position=0）**。强势趋势里 RSI 可长期超买，缩量仅表示短期整理，价格常会继续创新高；此时清仓容易**过早离场、再在高位追回**，拉低收益。
- **建议**：
  - 在**上升趋势**中，对「超买 + 缩量」可不直接清仓，改为**减仓**（若后续支持部分仓位）或**仅依赖止盈/趋势破位出场**（如启用 use_ma50_exit：收盘跌破 MA50 再平多）；
  - 或增加配置项：如 `bull_hold_on_overbought: true`，在 bull 下忽略「超买+缩量」的 sell_light，只靠止损/止盈/死叉/MA50 破位出场。

### 6.5 小结与优先动作

| 原因 | 影响 | 可做改动 |
|------|------|----------|
| 盈亏比 < 1，止损先于止盈 | 总盈利 < 总亏损 | 放宽 SL 或提高 TP、或 ATR 止损 |
| 超卖入场 + 2% 止损过紧 | 抄底后易被震出 | 超卖类入场单独放宽 SL，或加入场过滤 |
| 在仓时间占比低 | 错过牛段大部分涨幅 | 统计在仓占比；趋势中放宽开仓或趋势持有 |
| 超买+缩量即清仓 | 趋势中过早离场 | bull 下忽略 sell_light 或仅减仓/趋势破位出场 |

**建议优先**：  
1）将**超卖/强超卖**的 `stop_loss_ratio` 从 0.02 提到 **0.03**，或把对应 `take_profit_ratio` 从 0.05 提到 **0.07**，再跑回测看 profit_factor 和 total_return 是否改善；  
2）在**上升趋势**中减少「超买+缩量」导致的清仓（配置或逻辑上二选一）；  
3）增加**在仓占比**统计，确认是否因空仓时间过长导致收益不及买入持有。
