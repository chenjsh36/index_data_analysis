# 需求规格说明书（SRS / PRD）— v5 信号可读化与推导逻辑展示

**文档编号**：SRS-NDX-RSI-v5  
**文档版本**：1.0  
**产出日期**：2026-02-12  
**依据**：研发流程步骤 2 - 需求文档  
**参考规范**：IEEE 830-1998、ISO/IEC/IEEE 29148、FURPS+、需求可追溯性矩阵（RTM）  
**上游输入**：v4 已实现的 run_signal（当前输出 raw dict）、nasdaq_v1 的 print_trend_report / print_trend_report_v2 可读格式  
**变更性质**：将 run_signal 的终端输出从「原始对象」改为可读报告，并增加「指标 → 操作建议」的推导逻辑说明，便于用户理解为何给出该建议

---

## 1. 项目概述

### 1.1 背景

index_data_analysis 的 `run_signal` 子命令当前直接打印策略返回的 `Signal` 与 `Risk` 字典（如 `Signal: {'signal': 'buy', 'position': 1.0, 'reason': 'uptrend_low_vol'}`），不利于阅读。nasdaq_v1 的每日趋势检测则采用格式化报告：当前日期、收盘价、策略涉及指标（如 EMA80/200、20 日波动率及阈值）、趋势/波动率状态、操作建议，分行展示、一目了然。用户进一步希望看到**从指标数值到操作建议的推导逻辑**，以便理解「为什么给出这样的建议」。v5 在不大改策略接口的前提下，对 run_signal 的展示层做增强。

### 1.2 目标

- 将 `run_signal` 的终端输出改为**可读报告格式**，参考 nasdaq_v1 的排版与信息密度。
- 报告内容包含：**当前日期**、**收盘价**、**策略涉及指标数值**（如 EMA、波动率、阈值等）、**操作建议**（中文、与 signal/position 一致）。
- 增加**推导逻辑**：用一句或几句中文说明「依据当前指标与策略规则，如何得出该操作建议」，便于用户理解因果。
- 推导逻辑按策略不同实现：每个策略在展示层使用「规则模板 + 当前数值与 reason」拼出说明，不要求策略层新增接口。

### 1.3 范围

| 维度 | 范围内 | 范围外 |
|------|--------|--------|
| 输出形态 | run_signal 的终端打印（CLI 展示层） | run_signal 的返回值结构（仍为 sig/risk，供程序调用）、API/Web 输出 |
| 策略 | NDX_short_term、EMA_cross_v1、EMA_trend_v2（各策略一套报告模板与推导文案） | 尚未接入的其他策略（可后续按同模式扩展） |
| 推导逻辑 | 由展示层根据策略名 + 当前指标 + sig.reason 拼出固定规则的中文说明 | 策略层新增 get_report() 等接口（可选后续迭代） |
| 用户 | 使用 CLI 查看当前信号的量化/交易用户 | 仅通过 API 消费 signal dict 的调用方（不受影响） |

---

## 2. 功能需求（详细描述）

### 2.1 可读报告格式（FR-V5-01）

**描述**：`run_signal` 执行后，终端输出改为结构化、分行、带标签的可读报告，而非直接打印 Python 对象。

**详细要求**：

- **版式**：参考 nasdaq_v1 的 `print_trend_report_v2`（如 `trend.py` 第 155–166 行）：分隔线（如 `"=" * 55`）、标题行（含标的、策略名、日期）、随后多行「标签: 数值」、结尾分隔线。
- **标题**：至少包含标的（如 QQQ）、策略名称（如 EMA_trend_v2）、信号日期（当前数据对应的日期，如最新一根 K 线的日期）。
- **必选字段**：当前日期、收盘价、操作建议（中文，与 position/signal 对应）；风控信息（止损、止盈，可从 risk 取）。
- **策略相关指标**：按策略展示该策略用到的指标及数值，例如：
  - **EMA_cross_v1**：EMA50、EMA200（及可选前一日值用于说明是否发生交叉）。
  - **EMA_trend_v2**：EMA80、EMA200、20 日波动率、波动率阈值。
  - **NDX_short_term**：MA50、RSI(9)、RSI(24)、量能比等（与现有策略逻辑一致）。
- **顺序建议**：日期 → 收盘价 → 策略指标（多行）→ 推导逻辑（见 FR-V5-02）→ 操作建议 → 止损/止盈。

**验收标准**：

- 执行 `run_signal --strategy EMA_trend_v2 --symbol QQQ` 后，终端输出为分行、带明确标签的文本，无 raw dict 形式的 `Signal: {...}`、`Risk: {...}`（或仅在调试模式下保留）。
- 报告中可直观看到当前日期、收盘价、EMA80、EMA200、波动率与阈值、操作建议、止损止盈。
- EMA_cross_v1、NDX_short_term 同理，展示各自策略的指标与建议。

---

### 2.2 推导逻辑展示（FR-V5-02）

**描述**：在可读报告中增加「推导逻辑」部分，用中文说明从当前指标数值到操作建议的依据，便于用户理解「为什么给出这样的建议」。

**详细要求**：

- **含义**：推导逻辑 = 策略规则的文字化 + 当前数值与 reason 的填入。即：每个策略的规则是已知的，在展示层为每个策略维护一段或若干段「规则模板」，根据当前指标和 `sig["reason"]`（及 position）选择对应模板，填入具体数值，生成一句或几句中文说明。
- **EMA_cross_v1 示例**：
  - 若 reason 为黄金交叉：说明「EMA50(值) 上穿 EMA200(值) → 黄金交叉 → 建议买入/持有」。
  - 若 reason 为死亡交叉：说明「EMA50(值) 下穿 EMA200(值) → 死亡交叉 → 建议卖出/空仓」。
  - 若为维持持有/空仓：说明「EMA50 与 EMA200 相对关系 + 未发生交叉 → 维持当前仓位」。
- **EMA_trend_v2 示例**：
  - 说明「EMA80(值) 与 EMA200(值) 比较 → 上升/下降趋势；vol_20(值) 与阈值(值) 比较 → 低/高波动；趋势 + 波动率 → 满仓/减仓/空仓」。
- **NDX_short_term**：可根据 reason（如 no_signal、overbought、oversell、golden_cross 等）与市场环境，用简短中文说明「当前 RSI/均线/量能 满足何种条件 → 对应建议」。
- **实现方式**：在 CLI 或专用「报告格式化」模块中，按策略名分支，根据 `df` 最后一行指标、`sig`、配置（如阈值）拼出推导逻辑字符串，不要求策略类新增接口。

**验收标准**：

- 报告中存在明确的「推导逻辑」或「逻辑说明」段落（或一行），内容与当前 signal/reason 及指标数值一致。
- 用户阅读后能理解「依据哪些指标、满足哪条规则，因此得到该操作建议」。
- 不同 reason（如 golden_cross 与 hold）下，推导逻辑文案不同且正确。

---

### 2.3 策略覆盖与扩展性（FR-V5-03）

**描述**：首版覆盖 NDX_short_term、EMA_cross_v1、EMA_trend_v2 三种策略的可读报告与推导逻辑；新增策略时，可沿用同一套「报告格式 + 按策略名分支写推导模板」的方式扩展。

**详细要求**：

- 三种策略均有对应的报告模板与推导逻辑模板（或等价逻辑），不出现「未知策略则回退为 raw dict」的默认行为时仍保证有基本可读输出（如至少打印日期、收盘价、signal/position 中文、止损止盈）。
- 若未来新增策略，扩展方式为：在报告格式化处增加该策略的分支，补充其指标列表与推导模板，无需修改策略类的 generate_signal/calculate_risk 接口。

**验收标准**：

- run_signal 对上述三种策略均输出可读报告且含推导逻辑。
- 文档或代码注释说明「新增策略时如何添加报告与推导逻辑」。

---

## 3. 非功能需求

### 3.1 向后兼容（NFR-V5-01）

- 程序化调用 run_signal 时，若依赖其返回值（如 sig、risk），现有返回值结构不变；仅**打印内容**从 raw 对象改为可读报告。
- 可通过可选参数（如 `--format human` / `--format raw`）在「可读报告」与「仅打印 dict」之间切换时，默认行为为可读报告；未实现该参数时，默认仅输出可读报告即可。

### 3.2 可维护性（NFR-V5-02）

- 推导逻辑与报告版式集中在 CLI 或独立「报告格式化」模块（如 `ndx_rsi/report/` 或 `cli_main` 内函数），策略层保持「只返回 sig/risk」的单一职责。
- 各策略的推导模板与指标列表便于定位与修改（如按策略名分支或策略与 formatter 一一对应）。

### 3.3 可测试性（NFR-V5-03）

- 给定固定的 df 最后一行、sig、risk，报告格式化输出可断言（如包含预期日期、数值、推导关键词）；无需依赖真实网络或完整 run_signal 流程。

---

## 4. 约束条件

| 类型 | 约束内容 |
|------|----------|
| 接口 | 不强制策略类新增方法（如 get_report）；推导逻辑由展示层根据既有 sig/df/risk 拼出。 |
| 范围 | 仅终端输出形态与内容，不改变 run_signal 的数据拉取、预计算、策略调用逻辑。 |
| 语言 | 报告与推导逻辑为中文，与 nasdaq_v1 及现有产品文案一致。 |

---

## 5. 验收标准汇总

| 需求 ID | 验收标准摘要 |
|---------|--------------|
| FR-V5-01 | run_signal 输出为分行、带标签的可读报告；含日期、收盘价、策略指标、操作建议、止损止盈；无 raw dict 直接打印。 |
| FR-V5-02 | 报告中含「推导逻辑」说明，与当前 reason/指标一致；用户能理解从指标到建议的因果。 |
| FR-V5-03 | NDX_short_term、EMA_cross_v1、EMA_trend_v2 均有对应报告与推导；扩展方式明确。 |
| NFR-V5-01 | 返回值结构不变；默认仅改变打印内容。 |
| NFR-V5-02 | 报告与推导逻辑集中在展示层，策略层不改接口。 |
| NFR-V5-03 | 报告格式化可单测（给定 df/sig/risk 断言输出）。 |

---

## 6. 术语表

沿用项目既有术语，新增如下：

| 术语 | 英文 | 说明 |
|------|------|------|
| 可读报告 | Human-readable report | 分行、带标签的终端输出，便于人眼阅读。 |
| 推导逻辑 | Derivation / Reasoning | 从指标数值与策略规则到操作建议的文字说明，用于解释「为何给出该建议」。 |
| 规则模板 | Rule template | 按策略写死的说明文案，填入当前数值与 reason 后得到推导逻辑句子。 |

---

## 7. 需求可追溯性矩阵（RTM）

| 本 SRS 需求 | 上游来源 | 代码/配置影响 |
|-------------|----------|----------------|
| FR-V5-01 | nasdaq_v1 print_trend_report、用户对可读性的要求 | ndx_rsi/cli_main.py 或新建 report 模块 |
| FR-V5-02 | 用户对「为何这样建议」的理解需求 | 同上，按策略维护推导模板 |
| FR-V5-03 | 多策略与后续扩展 | 同上，分支或策略→formatter 映射 |

---

## 8. 需求变更日志

| 版本 | 日期 | 变更说明 | 作者/来源 |
|------|------|----------|-----------|
| 1.0 | 2026-02-12 | 初版 v5 PRD：run_signal 可读化、推导逻辑展示、策略覆盖与扩展性 | 步骤 2 产出 |

---

**下一步**：本步骤完成后，请确认需求文档内容是否准确；确认后将进入「步骤 3：技术栈选择」与「步骤 4：技术方案设计」。
