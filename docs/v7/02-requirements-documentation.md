# 需求规格说明书（PRD/SRS）— v7 纳指机构级策略

**文档类型**：需求文档（步骤 2）  
**依据**：`docs/v7/brd.md`、前述对话（方案 B：新策略类「纳指机构级」）  
**参考规范**：IEEE 830、ISO/IEC/IEEE 29148、PRD、FURPS+

---

## 1. 项目概述

### 1.1 背景

- 现有 **index_data_analysis** 已具备：80/200 EMA 趋势策略（EMA_trend_v2）、20 日波动率过滤、RSI 组合信号等。
- v7 BRD 整理了一套**专门适配纳指（QQQ/NDX）的趋势判断指标**，并给出「最强进场条件」：80EMA > 200EMA、收盘价 > 80EMA、ADX > 25、MACD 在 0 轴上方、VIX < 25；满足则做多，不满足则空仓。
- 需求方选择**方案 B**：新增独立策略类「纳指机构级」，显式实现上述五条件，便于单独回测与实盘对比，不与现有 v2 混在一起。

### 1.2 目标

- **新策略**：实现「纳指机构级」策略（如命名 `EMA_trend_v3` 或 `NDX_institutional`）。**仅以条件 1（80EMA > 200EMA）作为是否做多依据**；条件 2～5（收盘>80EMA、ADX>25、MACD>0、收盘>SMA200）作为**辅助指标**在报告中展示供用户参考；**五条件全部满足时给出强烈买入**，仅条件 1 满足时做多但不标为强烈买入。
- **新指标**：在指标层新增 ADX(14)、MACD(12,26,9)；SMA200 复用现有 `calculate_ma`；可选接入 VIX 数据并传入策略。
- **可维护与可测**：策略、数据准备、报告均独立于 v2，不破坏现有 CLI 与回测；新策略可单独回测并对比 v2 绩效。

### 1.3 范围

| 范围内 | 范围外（本期不做） |
|--------|-------------------|
| 新增 ADX、MACD 指标计算模块 | 布林带、RSI 健康度 50–70 等辅助指标（可后续迭代） |
| 新策略类：五条件 + 可选 VIX + 可选 20 日波动率过滤 | 修改现有 EMA_trend_v2 逻辑 |
| 数据准备：仅在该策略分支中计算 sma_200、adx_14、macd_line 等列 | 为其他策略统一预计算上述指标 |
| 策略注册（factory、config）、回测与 run_signal 支持新策略名 | 实盘下单、交易执行 |
| 可选：VIX 数据源拉取（如 ^VIX）并传入策略 | 必须接入 VIX（无 VIX 时策略仍可运行，仅不做 VIX 过滤） |
| 报告：新策略的信号说明与条件展示 | 多标的多策略配置 UI |

---

## 2. 功能需求

### 2.1 指标层：ADX、MACD、SMA200

| ID | 功能描述 | 验收标准 |
|----|----------|----------|
| FR-1 | 新增 ADX（14 日）计算 | 提供函数（如 `calculate_adx(high, low, close, period=14)`），输出 ADX 序列；实现方式可为手写（+DM、-DM、TR、平滑）或 TA-Lib；在 `ndx_rsi/indicators` 中导出 |
| FR-2 | 新增 MACD（12,26,9）计算 | 提供函数输出至少「MACD 线」（或 histogram），用于 0 轴判断；公式：EMA12、EMA26、MACD_line = EMA12 - EMA26；在 `ndx_rsi/indicators` 中导出 |
| FR-3 | SMA200 用于新策略 | 复用现有 `calculate_ma(series, 200)`，在数据准备阶段写入列（如 `sma_200`），无需新增指标函数 |

### 2.2 策略层：纳指机构级策略

| ID | 功能描述 | 验收标准 |
|----|----------|----------|
| FR-4 | 新增策略类并注册 | 新增策略类（如 `EMATrendV3Strategy` 或 `NDXInstitutionalStrategy`），继承 `BaseTradingStrategy`；在 `ndx_rsi/strategy/factory.py` 中为该策略名（如 `EMA_trend_v3`）返回该类实例；在 `config/strategy.yaml`（或等价配置）中增加该策略配置段 |
| FR-5 | 做多条件与辅助指标 | **做多仅看条件 1**：80EMA > 200EMA 时 `position=1.0`、`signal="buy"`；否则 `position=0.0`。条件 2～5（收盘>80EMA、ADX>25、MACD>0、收盘>SMA200）**不作为入场条件**，仅在报告中展示供用户参考。当**五条件全部满足**时 `reason="all_conditions_met"`，报告给出**强烈买入**；仅条件 1 满足时 `reason="uptrend"`，报告为做多/满仓持有。可选 VIX、vol_20 仍可作过滤（见 FR-6、FR-7） |
| FR-6 | 可选 VIX 过滤 | 若调用时传入 VIX（如通过 config 或 `generate_signal(..., vix=float)`），则增加条件：VIX < 25 才允许做多；若未传入 VIX，则不进行 VIX 判断（视为通过） |
| FR-7 | 可选 20 日波动率过滤 | 可选配置：当启用时，需同时满足 `vol_20 < vol_threshold` 才做多，与 v2 逻辑一致，避免高波动时满仓 |
| FR-8 | 风控与 calculate_risk | 新策略的 `calculate_risk` 可复用 v2 的止损/止盈比例逻辑（或从 config 读取 stop_loss_ratio、take_profit_ratio） |

### 2.3 数据准备：回测与 run_signal

| ID | 功能描述 | 验收标准 |
|----|----------|----------|
| FR-9 | 回测时为新策略计算所需列 | 在 `ndx_rsi/backtest/runner.py` 中，对策略名 `EMA_trend_v3`（或约定名）单独分支：计算并写入 `ema_80`、`ema_200`、`vol_20`、`sma_200`、`adx_14`、`macd_line`（列名可配置）；`loop_start` 不少于 200（因 SMA200 需要足够历史数据） |
| FR-10 | run_signal 时为新策略计算相同列 | 在 `ndx_rsi/cli_main.py` 的 `cmd_run_signal` 中，对同一策略名使用与回测一致的数据准备逻辑，保证实盘/回测同源 |
| FR-11 | 其他入口的数据准备 | 若 `scripts/run_signal_and_notify.py` 或 `scripts/generate_static_data.py` 会调用该策略，则在其策略分支中同样计算上述列，避免缺列报错 |

### 2.4 VIX 数据（可选）

| ID | 功能描述 | 验收标准 |
|----|----------|----------|
| FR-12 | VIX 数据拉取与传入 | 若实现 VIX 支持：在数据源或脚本层拉取 ^VIX 最近一个交易日数据；通过策略 config 或 `generate_signal(..., vix=float)` 传入；策略内仅当 `vix is not None` 时做 VIX < 25 判断 |

### 2.5 报告与可观测性

| ID | 功能描述 | 验收标准 |
|----|----------|----------|
| FR-13 | 新策略的报告展示 | 在 `ndx_rsi/report/signal_report.py` 中为 `EMA_trend_v3` 增加专用报告分支，输出内容满足 **2.6 信号报告输出内容细节** 的约定；风格与 v2 报告一致（分隔线、标题、指标逐行、推导逻辑、操作建议、止损止盈） |

### 2.6 信号报告输出内容细节（EMA_trend_v3）

本节约定 `run_signal` 对 **EMA_trend_v3** 策略生成的可读报告（文本）及可选结构化输出（如 `signal_report_to_dict`）应包含的字段与顺序。实现时与现有 `_report_ema_trend_v2` 对齐格式（分隔线 `"=" * 55`、标题行、指标行、推导逻辑、操作建议、止损止盈）。

#### 2.6.1 必出字段（按展示顺序）

| 序号 | 字段/区块 | 说明 | 示例或格式 |
|------|-----------|------|------------|
| 1 | 报告标题 | 策略名 + 标的 + 日期 | `【QQQ 纳指机构级(v3) 信号 - 2025-02-15】` |
| 2 | 收盘价 | 当日收盘价 | `收盘价: 485.32` |
| 3 | EMA80 | 80 日指数移动均线 | `EMA80: 478.20` |
| 4 | EMA200 | 200 日指数移动均线 | `EMA200: 455.10` |
| 5 | SMA200 | 200 日简单移动均线 | `SMA200: 452.80` |
| 6 | ADX(14) | 14 日平均趋向指数及阈值 | `ADX(14): 28.5  (阈值: 25)` |
| 7 | MACD 线 | MACD(12,26,9) 主线数值及 0 轴关系 | `MACD线: 1.25  (0轴上方)` 或 `MACD线: -0.30  (0轴下方)` |
| 8 | 五条件满足情况 | 逐条列出是否满足，便于排查 | 见下方 2.6.2 |
| 9 | 推导逻辑 | 根据 reason 与条件满足情况生成一句总结 | 五条件全满足：`五条件均满足 → 强烈买入`；仅条件1满足：`80EMA > 200EMA → 做多，其余条件供参考`；条件1不满足：`80EMA ≤ 200EMA → 空仓` |
| 10 | 操作建议 | 由 position 与 reason 决定 | 五条件全满足时为**强烈买入**；仅条件1满足时为满仓持有/做多；空仓时为空仓观望 |
| 11 | 止损 | 若有 | `止损: 460.65` |
| 12 | 止盈 | 若有 | `止盈: 519.30` |

#### 2.6.2 五条件满足情况（建议格式）

报告内应明确列出每条条件的**当前值/是否满足**，供用户参考（其中仅条件 1 决定是否做多）。建议格式（可单行或分多行）：

- **条件1** 80EMA > 200EMA：是 / 否（如 `478.20 > 455.10 → 是`）
- **条件2** 收盘价 > 80EMA：是 / 否
- **条件3** ADX > 25：是 / 否（可带当前 ADX 值）
- **条件4** MACD 在 0 轴上方：是 / 否
- **条件5** 收盘价 > SMA200：是 / 否

若启用**可选**过滤，也应展示：

- **VIX < 25**（若传入 VIX）：是 / 否，当前 VIX 值
- **20日波动率 < 阈值**（若启用）：是 / 否，当前 vol_20 与阈值

#### 2.6.3 结构化输出（可选）

若为静态页/JSON 提供 `signal_report_to_dict` 类输出，建议包含与 v2 对齐的字段，并增加 v3 独有项：

- 必有：`date`, `symbol`, `strategy`, `close`, `ema_fast`, `ema_slow`, `sma_200`, `adx_14`, `macd_line`, `conditions_met`（五条件布尔或列表）, `derivation`, `action`, `stop_loss`, `take_profit`
- 可选：`vix`, `vol_20`, `vol_threshold`（当启用时）

---

## 3. 非功能需求

| ID | 类别 | 描述 | 验收标准 |
|----|------|------|----------|
| NFR-1 | 兼容性 | 不破坏现有策略与 CLI | 现有 `EMA_trend_v2`、`NDX_short_term`、`run_signal`、`run_backtest` 等行为不变，回归可测 |
| NFR-2 | 可维护性 | 新策略与指标独立、可配置 | 新策略通过策略名与 config 启用；ADX/MACD 参数（周期等）可通过配置覆盖 |
| NFR-3 | 可测试性 | 回测可单独运行新策略 | 支持 `run_backtest --strategy EMA_trend_v3`（或约定名），且回测区间与 loop_start 正确（≥200 根 K 线） |

---

## 4. 约束条件

| ID | 约束类型 | 描述 |
|----|----------|------|
| C-1 | 实现方案 | 采用方案 B：独立新策略类，不修改 EMA_trend_v2 内部逻辑 |
| C-2 | 数据流 | 所有新指标在数据准备阶段算好并写入 DataFrame 列，策略只读列与可选参数（如 vix），与现有架构一致 |
| C-3 | 参考依据 | 业务规则与进场条件以 `docs/v7/brd.md` 为准 |

---

## 5. 验收标准（汇总）

- **指标**：ADX(14)、MACD(12,26,9) 可计算并导出；SMA200 通过现有 `calculate_ma` 在数据准备中写入。
- **策略**：新策略名已注册，做多仅看条件 1（80EMA>200EMA）；条件 2～5 为辅助指标在报告中展示；五条件全满足时 reason=all_conditions_met、报告为强烈买入；可选 VIX、vol_20 过滤。
- **数据准备**：回测与 run_signal 中该策略分支正确计算并注入所需列；回测 loop_start ≥ 200。
- **信号报告**：EMA_trend_v3 的报告输出符合 **2.6 信号报告输出内容细节**（必出字段、五条件满足情况、推导逻辑、操作建议、止损止盈；可选结构化字段）。
- **兼容**：现有策略与 CLI 行为不变。
- **可选**：VIX 拉取与传入、`signal_report_to_dict` 对 v3 的结构化字段。

---

## 6. 术语表（Glossary）

| 术语 | 说明 |
|------|------|
| BRD v7 | `docs/v7/brd.md`，纳指专用趋势指标与「最强进场条件」说明 |
| 五条件 | 条件1：80EMA>200EMA（做多依据）；条件2～5：收盘>80EMA、ADX>25、MACD>0、收盘>SMA200（辅助参考）；五条件全满足时强烈买入 |
| EMA_trend_v3 | 本需求中新增策略名称（可与实现协商为 NDX_institutional 等），纳指机构级策略 |
| ADX | 平均趋向指数，14 日，用于判断趋势强弱；BRD 标准：>25 为强趋势 |
| MACD | 12,26,9 参数；BRD 用法：MACD 线在 0 轴上方为多头 |
| SMA200 | 200 日简单移动均线；BRD：价格在 SMA200 上方才做多 |
| VIX | 恐慌指数；BRD：>30 忽略买入，进场建议 VIX<25 |

---

## 7. 需求变更日志

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| v7 | 2025-02-15 | 初版：基于 v7 brd.md 与方案 B 对话，新增「纳指机构级」策略需求；指标 ADX/MACD/SMA200、数据准备、可选 VIX、报告；补充 2.6 信号报告输出内容细节。 |
| v7.1 | 2025-02-15 | 做多逻辑调整：仅以条件 1（80EMA>200EMA）为做多依据；条件 2～5 为辅助指标供参考；五条件全满足时给出强烈买入 |

---

**下一步**：完成本步骤后需用户确认；确认后进入步骤 3「技术栈选择」或直接进入技术方案与开发拆分。
