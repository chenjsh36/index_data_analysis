# 需求规格说明书（PRD/SRS）— v8 纳指 50日均线+成交量+RSI 三合一策略

**文档类型**：需求文档（步骤 2）  
**依据**：`docs/v8/brd.md`、`docs/v8/feasibility-assessment.md`  
**参考规范**：IEEE 830、ISO/IEC/IEEE 29148、FURPS+

---

## 1. 项目概述

### 1.1 背景

- 现有 **index_data_analysis** 已具备：EMA 趋势策略（v2/v3）、NDX 短线 RSI 策略（`NDX_short_term`）、50 日均线市场环境（`judge_market_env`）、成交量比值（`volume_ratio`）等。
- v8 BRD 定义了一套**纳指专属「趋势→动能→点位」三合一判断**：**50 日均线定多空前提**，**成交量验证信号有效性**，**RSI(14) 精准择时**；并给出完整伪代码（趋势判定 + RSI+量能信号表），经 2018–2025 纳指历史验证。
- 需求方选择**新增独立策略**：不修改现有 NDX_short 或 EMA 策略，单独实现 BRD 伪代码逻辑，便于回测与实盘对比。

### 1.2 目标

- **新策略**：实现「纳指 50日均线+成交量+RSI 三合一」策略，**策略名为 `NDX_MA50_Volume_RSI`**。**趋势与信号规则完全按 BRD 执行**（以 `docs/v8/brd.md` 及其中伪代码为准）：
  - **趋势判定**：SMA50 连续 3 日方向 + 无连续 2 日收盘破位/站上；震荡为 SMA50 连续 5 日斜率绝对值 &lt;0.1% 且收盘在 SMA50±3%。
  - **信号规则**：按「上升/下降/震荡」三分支，结合 RSI(14) 区间与 vol_ratio（1.2 放量/0.8 缩量）输出操作建议（加仓/减仓/轻仓试多/观望等），并映射为 `signal`、`position`、`reason`。
- **指标与数据**：复用 `ma50`（SMA50）、`volume_ratio`（20 日均量比）；新增或显式使用 **RSI(14)** 作为主 RSI；SMA50 斜率及趋势类型在策略内计算。
- **可维护与可测**：策略独立、可配置；可单独回测并与现有策略对比；不破坏现有 CLI 与 backtest。

### 1.3 范围

| 范围内 | 范围外（本期不做） |
|--------|-------------------|
| 新策略类：BRD 第三步趋势 + 第四步 RSI+量能信号（基础版伪代码全覆盖） | 背离、金叉死叉、多日量价背离反转预警（可后续迭代） |
| 数据准备：sma50、sma50_slope_pct、rsi_14、volume_ratio 等列 | 修改现有 NDX_short / judge_market_env 内部逻辑 |
| 策略注册（factory、config）、回测与 run_signal 支持新策略名 | 实盘下单、交易执行 |
| 报告：新策略的趋势类型、RSI、vol_ratio、操作建议、止损止盈 | 多标的多策略配置 UI、权重股同步放量等外部数据 |

---

## 2. 功能需求

### 2.1 指标与中间量

| ID | 功能描述 | 验收标准 |
|----|----------|----------|
| FR-1 | SMA50（50 日简单移动均线） | 复用现有 `calculate_ma(close, 50)`，在数据准备或策略内得到列 `sma50` 或 `ma50`（与现有命名一致即可） |
| FR-2 | SMA50 斜率（用于趋势与震荡判定） | 策略内可计算：`sma50_slope = sma50[i] - sma50[i-1]`，`sma50_slope_pct = (sma50_slope / sma50[i-1]) * 100`；震荡判定要求连续 5 日 `abs(sma50_slope_pct) < 0.1` |
| FR-3 | RSI(14) 作为主 RSI | 使用现有 `calculate_rsi_handwrite(close, 14)`，在数据准备或策略内得到列 `rsi_14`；与 BRD 伪代码一致 |
| FR-4 | 20 日均量比 volume_ratio | 复用现有 `calculate_volume_ratio(volume, 20)`；放量 ≥1.2、缩量 ≤0.8 与 BRD 一致 |

### 2.2 策略层：趋势判定（BRD 第三步）

| ID | 功能描述 | 验收标准 |
|----|----------|----------|
| FR-5 | 上升趋势 | 当且仅当：① 收盘 &gt; SMA50；② SMA50 连续 3 日向上（当日 &gt; 前一日 &gt; 再前一日 &gt; 再前二日）；③ 非「连续 2 日收盘均跌破当日对应 SMA50」；则 `trend_type = "上升趋势"` |
| FR-6 | 下降趋势 | 当且仅当：① 收盘 &lt; SMA50；② SMA50 连续 3 日向下；③ 非「连续 2 日收盘均站上当日对应 SMA50」；则 `trend_type = "下降趋势"` |
| FR-7 | 震荡趋势 | 当且仅当：① SMA50 连续 5 日斜率绝对值 &lt; 0.1%；② 收盘在 SMA50 的 [0.97, 1.03] 倍之间；则 `trend_type = "震荡趋势"`（仅在上升/下降均不满足时再判） |
| FR-8 | 趋势过渡 | 以上均不满足时为「趋势过渡（无明确方向）」；信号层按「观望」或与现有 transition 行为一致 |

### 2.3 策略层：RSI+成交量信号（BRD 第四步）

| ID | 功能描述 | 验收标准 |
|----|----------|----------|
| FR-9 | 上升趋势下的信号 | ① RSI14∈[40,50] 且 vol_ratio≤0.8 → 有效加仓（position 提升，reason 如 `bull_pullback_volume_ok`）；② RSI14∈[70,80] 且 vol_ratio≤0.8 → 轻仓减仓；③ RSI14&gt;80 且 vol_ratio≥1.2 → 继续持仓；其余默认观望/维持 |
| FR-10 | 下降趋势下的信号 | ① RSI14∈[50,60] 且 vol_ratio≥1.2 → 减仓；② RSI14∈[20,30] 且 vol_ratio≤0.8 → 轻仓试多；③ RSI14&lt;20 且 vol_ratio≥1.2 → 观望不抄底；其余默认观望/维持 |
| FR-11 | 震荡趋势下的信号 | ① RSI14∈[65,70] 且 vol_ratio≥1.2 → 减仓；② RSI14∈[30,35] 且 vol_ratio≤0.8 → 加仓；其余默认观望 |
| FR-12 | 信号与 position 映射 | 策略输出标准 `generate_signal` 返回：`signal`（buy/sell/hold）、`position`（0.0~1.0）、`reason`（可读字符串）；操作建议与 BRD 表格一致，并可被报告使用 |

### 2.4 策略注册与配置

| ID | 功能描述 | 验收标准 |
|----|----------|----------|
| FR-13 | 新策略类与工厂注册 | 新增策略类（如 `NDXMA50VolumeRSIStrategy`），继承 `BaseTradingStrategy`；在 `ndx_rsi/strategy/factory.py` 中为策略名 **`NDX_MA50_Volume_RSI`** 返回该类实例 |
| FR-14 | 配置文件 | 在 `config/strategy.yaml` 中增加 **`NDX_MA50_Volume_RSI`** 配置段，包含至少：`index_code`（如 QQQ）、`rsi_period`（14）、`vol_ratio_heavy`（1.2）、`vol_ratio_light`（0.8）、`risk_control`（止损/止盈比例）；可选：震荡斜率阈值 0.1、SMA50±3% 等 |

### 2.5 数据准备：回测与 run_signal

| ID | 功能描述 | 验收标准 |
|----|----------|----------|
| FR-15 | 回测时为新策略计算所需列 | 在 `ndx_rsi/backtest/runner.py` 中，对新策略名单独分支：计算并写入 `ma50`/`sma50`、`rsi_14`、`volume_ratio`；若策略内自算斜率则可不写 slope 列；`loop_start` 不少于 50（建议 60 以保 50+20+14 数据完整） |
| FR-16 | run_signal 时为新策略计算相同列 | 在 `ndx_rsi/cli_main.py` 的 `cmd_run_signal` 中，对新策略名使用与回测一致的数据准备逻辑，保证同源 |

### 2.6 风控与 calculate_risk

| ID | 功能描述 | 验收标准 |
|----|----------|----------|
| FR-17 | 止损/止盈 | 新策略的 `calculate_risk` 根据 `reason` 与 config 的 `risk_control` 返回止损、止盈价位；BRD 中「止损 MA50 下方 2%」「止损 MA20 下方 3%」等可在 reason 或配置中体现，实现时与现有策略风格一致 |

### 2.7 报告与可观测性

| ID | 功能描述 | 验收标准 |
|----|----------|----------|
| FR-18 | 新策略的报告展示 | 在 `ndx_rsi/report/signal_report.py` 中为新策略增加报告分支，输出：日期、标的、策略名、收盘价、SMA50、趋势类型、RSI(14)、volume_ratio、操作建议（reason）、止损/止盈；风格与现有报告一致 |

### 2.8 信号报告输出内容细节（NDX_MA50_Volume_RSI）

| 序号 | 字段/区块 | 说明 |
|------|-----------|------|
| 1 | 报告标题 | 策略名 + 标的 + 日期 |
| 2 | 收盘价、SMA50 | 当日收盘价与 50 日均线值 |
| 3 | 趋势类型 | 上升趋势 / 下降趋势 / 震荡趋势 / 趋势过渡 |
| 4 | RSI(14)、成交量比值 | 14 日 RSI 与 vol_ratio（相对 20 日均量） |
| 5 | 推导逻辑 | 根据 trend_type + RSI 区间 + 量能 简述为何得到当前操作 |
| 6 | 操作建议 | 与 reason 一致（加仓/减仓/轻仓试多/观望等） |
| 7 | 止损、止盈 | 若有 |

---

## 3. 非功能需求

| ID | 类别 | 描述 | 验收标准 |
|----|------|------|----------|
| NFR-1 | 兼容性 | 不破坏现有策略与 CLI | 现有 `EMA_trend_v2`、`EMA_trend_v3`、`NDX_short_term`、`run_signal`、`run_backtest` 等行为不变 |
| NFR-2 | 可维护性 | 新策略与阈值可配置 | 趋势/震荡阈值（0.1%、±3%）、RSI 区间、vol_ratio 阈值等可通过 config 覆盖 |
| NFR-3 | 可测试性 | 回测可单独运行新策略 | 支持 `run_backtest --strategy NDX_MA50_Volume_RSI`，且回测区间与最小 K 线数正确（≥60） |

---

## 4. 约束条件

| ID | 约束类型 | 描述 |
|----|----------|------|
| C-1 | 实现方案 | 独立新策略类，不修改现有 NDX_short、judge_market_env、EMA 策略内部逻辑 |
| C-2 | 数据流 | 指标在数据准备阶段或策略内计算，策略只读 DataFrame 列与 config，与现有架构一致 |
| C-3 | 参考依据 | 业务规则与伪代码以 `docs/v8/brd.md` 为准；趋势与信号逻辑与 BRD 第三步、第四步一致 |

---

## 5. 验收标准（汇总）

- **趋势**：上升/下降/震荡/过渡判定与 BRD 伪代码第三步一致（连续 3 日 SMA50 方向、连续 2 日破位检查、震荡 5 日斜率 &lt;0.1% 与 ±3%）。
- **信号**：上升/下降/震荡三分支下，RSI(14) 与 vol_ratio 组合与 BRD 第四步表格一致，并映射为标准 signal/position/reason。
- **指标**：SMA50、RSI(14)、volume_ratio 可用；斜率在策略内可算。
- **策略**：策略名 **NDX_MA50_Volume_RSI** 已注册，config 段存在，回测与 run_signal 均能调用并得到正确列；趋势与信号规则完全按 BRD 执行。
- **报告**：新策略有专用报告分支，包含趋势类型、RSI、vol_ratio、操作建议、止损止盈。
- **兼容**：现有策略与 CLI 行为不变。

---

## 6. 术语表（Glossary）

| 术语 | 说明 |
|------|------|
| BRD v8 | `docs/v8/brd.md`，纳指 50日均线+成交量+RSI 三合一判断方法与伪代码 |
| SMA50 | 50 日简单移动均线；BRD 趋势分水岭 |
| vol_ratio / volume_ratio | 当日成交量 / 20 日均量；≥1.2 放量，≤0.8 缩量 |
| RSI(14) | 14 日 RSI，BRD 核心择时指标 |
| 上升/下降/震荡/趋势过渡 | BRD 第三步定义的四种趋势类型 |
| NDX_MA50_Volume_RSI | 本需求中确定的策略名称；趋势与信号规则完全按 BRD 执行 |

---

## 7. 需求变更日志

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| v8 | 2026-02-24 | 初版：基于 v8 brd.md 与 feasibility-assessment.md，新增「50日均线+成交量+RSI 三合一」策略需求；趋势判定（第三步）、RSI+量能信号（第四步）、指标与数据准备、报告。 |
| v8.1 | 2026-02-24 | 策略名确定为 **NDX_MA50_Volume_RSI**；明确趋势与信号规则完全按 BRD 执行。 |

---

**下一步**：完成本步骤后需用户确认；确认后进入步骤 4「技术方案设计」与开发拆分。
